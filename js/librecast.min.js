var LIBRECAST=function(t){"use strict";function e(t,e,i,n){var s,o;for(o=0;o<i;o++)(s=e.charCodeAt(o))<=127?n.setUint8(t++,s):s<=2047?(n.setUint8(t++,192|s>>>6),n.setUint8(t++,128|63&s)):s<=65535&&(n.setUint8(t++,224|s>>>12),n.setUint8(t++,128|s>>>6&63),n.setUint8(t++,128|63&s));return t}function i(){if(o.HAS_JQUERY)try{return t.Deferred()}catch(t){}}function n(t,e,i,n){this.obj=t,this.opcode=e,this.token=r++,this.temp=n,a[this.token]=this,"function"==typeof i&&(this.callback=i)}function s(t){this.code=t,this.name=o.ErrorMsg[t],this.errormsg="ERROR ("+this.code+") "+this.name}var o={};o.WS_CONNECTING=0,o.WS_OPEN=1,o.WS_CLOSING=2,o.WS_CLOSED=3,o.ERROR_SUCCESS=0,o.ERROR_FAILURE=1,o.ERROR_WEBSOCKET_UNSUPPORTED=2,o.ERROR_WEBSOCKET_NOTREADY=3,o.ERROR_CALLBACK_NOT_FUNCTION=4,o.OP_NOOP=1,o.OP_SETOPT=2,o.OP_SOCKET_NEW=3,o.OP_SOCKET_GETOPT=4,o.OP_SOCKET_SETOPT=5,o.OP_SOCKET_LISTEN=6,o.OP_SOCKET_IGNORE=7,o.OP_SOCKET_CLOSE=8,o.OP_SOCKET_MSG=9,o.OP_CHANNEL_NEW=10,o.OP_CHANNEL_GETMSG=11,o.OP_CHANNEL_GETOPT=12,o.OP_CHANNEL_SETOPT=13,o.OP_CHANNEL_GETVAL=14,o.OP_CHANNEL_SETVAL=15,o.OP_CHANNEL_BIND=16,o.OP_CHANNEL_UNBIND=17,o.OP_CHANNEL_JOIN=18,o.OP_CHANNEL_PART=19,o.OP_CHANNEL_SEND=20,o.HEADER_LENGTH=25,o.ErrorMsg={},o.ErrorMsg[o.ERROR_SUCCESS]="Success",o.ErrorMsg[o.ERROR_FAILURE]="Failure",o.ErrorMsg[o.ERROR_WEBSOCKET_UNSUPPORTED]="Browser does not support websockets",o.ErrorMsg[o.ERROR_WEBSOCKET_NOTREADY]="Websocket not ready",o.ErrorMsg[o.ERROR_CALLBACK_NOT_FUNCTION]="Callback not a function";var r=42,a={};return o.HAS_JQUERY="undefined"!=typeof jQuery,void 0===DataView.prototype.getUint64&&(DataView.prototype.getUint64=function(t,e){var i=e?0:4,n=e?4:0;return this.getUint32(t+n,e)<<32|this.getUint32(t+i,e)}),n.prototype.call=function(){if(void 0===a[this.token])return!1;if("function"==typeof this.callback){var t=[].slice.call(arguments);t.unshift(this),this.callback.apply(this,t)}this.temp&&delete a[this.token]},o.Librecast=function(t){if(this.url="https:"==location.protocol?"wss://":"ws://",this.url+=document.location.host+"/",!window.WebSocket)throw new s(ERROR_WEBSOCKET_UNSUPPORTED);this.id=void 0,this.onmessage=null,this.onready=t,this.init(),this.defer=i()},o.Librecast.prototype.init=function(){var t=this;this.websocket=new WebSocket(this.url,"librecast"),this.websocket.binaryType="arraybuffer",this.websocket.onclose=function(e){t.wsClose(e)},this.websocket.onerror=function(e){t.wsError(e)},this.websocket.onmessage=function(e){t.wsMessage(e)},this.websocket.onopen=function(e){t.wsOpen(e)}},o.Librecast.prototype.close=function(){this.websocket.close()},o.Librecast.prototype.wsClose=function(t){this.init()},o.Librecast.prototype.wsError=function(t){},o.Librecast.prototype.wsMessage=function(t){var e,n;if("object"==typeof t){if(t.data instanceof ArrayBuffer){var s=new DataView(t.data),r=s.getUint8(0),E=s.getUint32(1),c=s.getUint32(5),h=(s.getUint32(9),s.getUint32(13)),_=1e3*s.getUint64(17);if(E>0)if(r===o.OP_CHANNEL_SETVAL){var O=s.getUint64(o.HEADER_LENGTH);e=new StringView(t.data,"UTF-8",o.HEADER_LENGTH+8,O),n=new StringView(t.data,"UTF-8",o.HEADER_LENGTH+8+O)}else{n=new StringView(t.data,"UTF-8",o.HEADER_LENGTH,E).toString()}var N=a[h];N&&N.call(r,E,c,h,e,n,_)}}else this.onmessage;return i()},o.Librecast.prototype.wsOpen=function(t){this.defer&&this.defer.resolve(),"function"==typeof this.onready&&this.onready()},o.Librecast.prototype.send=function(t,i,s,r,a,E){void 0===a&&(a=0);var c=t.id,h=t.id2;void 0===t.id&&(c=0),void 0===t.id2&&(h=0);var _,O,N,l=new n(t,i,s,E);if("object"==typeof r){N=o.HEADER_LENGTH+a;var d=new Uint8Array(N);d.set(new Uint8Array(r),o.HEADER_LENGTH),_=d.buffer,O=new DataView(_)}else _=new ArrayBuffer(o.HEADER_LENGTH+4*a),O=new DataView(_),N=e(o.HEADER_LENGTH,r,a,O);O.setUint8(0,i),O.setUint32(1,N-o.HEADER_LENGTH),O.setUint32(5,c),O.setUint32(9,h),O.setUint32(13,l.token),this.websocket.send(_)},o.LibrecastChannel=function(t,e,s){this.lctx=t,this.id=void 0,this.ws=t.websocket,this.name=e;var r=new n(this,null,s);this.onready=r,t.send(this,o.OP_CHANNEL_NEW,this.ready,e,e.length),this.defer=i()},o.LibrecastChannel.prototype.bind=function(t,e){this.id=this.id,this.id2=t.id,this.lctx.send(this,o.OP_CHANNEL_BIND,e)},o.LibrecastChannel.prototype.bound=function(){},o.LibrecastChannel.prototype.join=function(t){this.lctx.send(this,o.OP_CHANNEL_JOIN,t)},o.LibrecastChannel.prototype.joined=function(){},o.LibrecastChannel.prototype.part=function(){this.lctx.send(this,o.OP_CHANNEL_PART,this.parted)},o.LibrecastChannel.prototype.parted=function(){},o.LibrecastChannel.prototype.ready=function(t,e,i,n){var s=t.obj;s.id=n,s.defer&&s.defer.resolve(),s.onready.call()},o.LibrecastChannel.prototype.getmsg=function(t){this.lctx.send(this,o.OP_CHANNEL_GETMSG,t,"","".length)},o.LibrecastChannel.prototype.getval=function(t,e){this.lctx.send(this,o.OP_CHANNEL_GETVAL,e,t,t.length,!0)},o.LibrecastChannel.prototype.setval=function(t,i,n){var s=t.length,r=i.length,a=4+4*(s+r),E=new ArrayBuffer(a),c=new DataView(E),h=4;c.setUint32(0,s),h=e(h=e(h,t,s,c),i,r,c),this.lctx.send(this,o.OP_CHANNEL_SETVAL,n,E,a,!0)},o.LibrecastChannel.prototype.send=function(t){if(this.lctx.websocket.readyState!=o.WS_OPEN)throw new s(ERROR_WEBSOCKET_NOTREADY);this.lctx.send(this,o.OP_CHANNEL_SEND,null,t,t.length)},o.LibrecastSocket=function(t,e){this.lctx=t,this.id=void 0;var s=new n(this,null,e,!0);this.onready=s,this.onmessage=void 0,t.send(this,o.OP_SOCKET_NEW,this.ready),this.defer=i()},o.LibrecastSocket.prototype.listen=function(t){this.lctx.send(this,o.OP_SOCKET_LISTEN,t)},o.LibrecastSocket.prototype.ready=function(t,e,i,n){var s=t.obj;s.id=n,s.defer&&s.defer.resolve(),s.onready.call()},o}(jQuery);
