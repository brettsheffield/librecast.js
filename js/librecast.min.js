var LIBRECAST=function(t){"use strict";function e(t,e,i,n){var o,s;for(s=0;s<i;s++)(o=e.charCodeAt(s))<=127?n.setUint8(t++,o):o<=2047?(n.setUint8(t++,192|o>>>6),n.setUint8(t++,128|63&o)):o<=65535&&(n.setUint8(t++,224|o>>>12),n.setUint8(t++,128|o>>>6&63),n.setUint8(t++,128|63&o));return t}function i(){if(s.HAS_JQUERY)try{return t.Deferred()}catch(t){}}function n(t,e,i,n){this.obj=t,this.opcode=e,this.token=r++,this.temp=n,E[this.token]=this,"function"==typeof i&&(this.callback=i)}function o(t){this.code=t,this.name=s.ErrorMsg[t],this.errormsg="ERROR ("+this.code+") "+this.name}var s={};s.WS_CONNECTING=0,s.WS_OPEN=1,s.WS_CLOSING=2,s.WS_CLOSED=3,s.ERR_SUCCESS=0,s.ERR_FAILURE=1,s.ERR_WEBSOCKET_UNSUPPORTED=2,s.ERR_WEBSOCKET_NOTREADY=3,s.ERR_CALLBACK_NOT_FUNCTION=4,s.ERR_MISSING_ARG=5,s.OP_NOOP=1,s.OP_SETOPT=2,s.OP_SOCKET_NEW=3,s.OP_SOCKET_GETOPT=4,s.OP_SOCKET_SETOPT=5,s.OP_SOCKET_LISTEN=6,s.OP_SOCKET_IGNORE=7,s.OP_SOCKET_CLOSE=8,s.OP_SOCKET_MSG=9,s.OP_CHANNEL_NEW=10,s.OP_CHANNEL_GETMSG=11,s.OP_CHANNEL_GETOPT=12,s.OP_CHANNEL_SETOPT=13,s.OP_CHANNEL_GETVAL=14,s.OP_CHANNEL_SETVAL=15,s.OP_CHANNEL_BIND=16,s.OP_CHANNEL_UNBIND=17,s.OP_CHANNEL_JOIN=18,s.OP_CHANNEL_PART=19,s.OP_CHANNEL_SEND=20,s.QUERY_NOOP=0,s.QUERY_EQ=1,s.QUERY_NE=2,s.QUERY_LT=4,s.QUERY_GT=8,s.QUERY_TIME=16,s.QUERY_SRC=32,s.QUERY_DST=64,s.QUERY_CHANNEL=128,s.QUERY_DB=256,s.QUERY_KEY=512,s.QUERY_MIN=1024,s.QUERY_MAX=2048,s.HEADER_LENGTH=25,s.ErrorMsg={},s.ErrorMsg[s.ERR_SUCCESS]="Success",s.ErrorMsg[s.ERR_FAILURE]="Failure",s.ErrorMsg[s.ERR_WEBSOCKET_UNSUPPORTED]="Browser does not support websockets",s.ErrorMsg[s.ERR_WEBSOCKET_NOTREADY]="Websocket not ready",s.ErrorMsg[s.ERR_CALLBACK_NOT_FUNCTION]="Callback not a function",s.ErrorMsg[s.ERR_MISSING_ARGUMENT]="Required argument is missing";var r=42,E={};return s.HAS_JQUERY="undefined"!=typeof jQuery,void 0===DataView.prototype.getUint64&&(DataView.prototype.getUint64=function(t,e){var i=e?0:4,n=e?4:0,o=new goog.math.Long(this.getUint32(t+n,e)).shiftLeft(32),s=new goog.math.Long(this.getUint32(t+i,e));return o.or(s)}),n.prototype.trigger=function(){if(void 0===E[this.token])return!1;if("function"==typeof this.callback){var t=[].slice.call(arguments);t.unshift(this),this.callback.apply(this.obj,t)}this.temp&&delete E[this.token]},s.Context=function(t){if(this.url="https:"==location.protocol?"wss://":"ws://",this.url+=document.location.host+"/",!window.WebSocket)throw new o(s.ERR_WEBSOCKET_UNSUPPORTED);this.id=void 0,this.onmessage=null,this.onready=t,this.init(),this.defer=i()},s.Context.prototype.init=function(){var t=this;this.websocket=new WebSocket(this.url,"librecast"),this.websocket.binaryType="arraybuffer",this.websocket.onclose=function(e){t.wsClose(e)},this.websocket.onerror=function(e){t.wsError(e)},this.websocket.onmessage=function(e){t.wsMessage(e)},this.websocket.onopen=function(e){t.wsOpen(e)}},s.Context.prototype.close=function(){this.websocket.close()},s.Context.prototype.wsClose=function(t){this.init()},s.Context.prototype.wsError=function(t){},s.Context.prototype.wsMessage=function(t){var e,n;if("object"==typeof t){if(t.data instanceof ArrayBuffer){var o=new DataView(t.data),r=o.getUint8(0),h=o.getUint32(1),_=o.getUint32(5),a=(o.getUint32(9),o.getUint32(13)),c=o.getUint64(17);if(h>0)if(r===s.OP_CHANNEL_SETVAL){var f=o.getUint64(s.HEADER_LENGTH).getLowBits();e=new StringView(t.data,"UTF-8",s.HEADER_LENGTH+8,f),n=new StringView(t.data,"UTF-8",s.HEADER_LENGTH+8+f)}else{n=new StringView(t.data,"UTF-8",s.HEADER_LENGTH,h).toString()}var N=E[a];N&&N.trigger(r,h,_,a,e,n,c)}}else this.onmessage;return i()},s.Context.prototype.wsOpen=function(t){this.defer&&this.defer.resolve(),"function"==typeof this.onready&&this.onready()},s.Context.prototype.send=function(t,i,o,r,E,h){void 0===E&&(E=0);var _=t.id,a=t.id2;void 0===t.id&&(_=0),void 0===t.id2&&(a=0);var c,f,N,d=new n(t,i,o,h);if("object"==typeof r){N=s.HEADER_LENGTH+E;var u=new Uint8Array(N);u.set(new Uint8Array(r),s.HEADER_LENGTH),c=u.buffer,f=new DataView(c)}else c=new ArrayBuffer(s.HEADER_LENGTH+4*E),f=new DataView(c),N=e(s.HEADER_LENGTH,r,E,f);f.setUint8(0,i),f.setUint32(1,N-s.HEADER_LENGTH),f.setUint32(5,_),f.setUint32(9,a),f.setUint32(13,d.token),this.websocket.send(c)},s.Channel=function(t,e,r){if(void 0==e)throw new o(s.ERR_MISSING_ARG);this.lctx=t,this.id=void 0,this.ws=t.websocket,this.name=e;var E=new n(this,null,r);this.onready=E,t.send(this,s.OP_CHANNEL_NEW,this.ready,e,e.length),this.defer=i()},s.Channel.prototype.bindSocket=function(t,e){this.id=this.id,this.id2=t.id,this.lctx.send(this,s.OP_CHANNEL_BIND,e)},s.Channel.prototype.join=function(t){this.lctx.send(this,s.OP_CHANNEL_JOIN,t)},s.Channel.prototype.joined=function(){},s.Channel.prototype.part=function(){this.lctx.send(this,s.OP_CHANNEL_PART,this.parted)},s.Channel.prototype.parted=function(){},s.Channel.prototype.ready=function(t,e,i,n){var o=t.obj;o.id=n,o.defer&&o.defer.resolve(),o.onready.trigger()},s.Channel.prototype.getmsg=function(t,e){void 0===e&&(e=new s.Query),this.lctx.send(this,s.OP_CHANNEL_GETMSG,t,e.packed(),e.size)},s.Channel.prototype.getval=function(t,e){this.lctx.send(this,s.OP_CHANNEL_GETVAL,e,t,t.length,!0)},s.Channel.prototype.setval=function(t,i,n){var o=t.length,r=i.length,E=4+4*(o+r),h=new ArrayBuffer(E),_=new DataView(h),a=4;_.setUint32(0,o),a=e(a=e(a,t,o,_),i,r,_),this.lctx.send(this,s.OP_CHANNEL_SETVAL,n,h,E,!0)},s.Channel.prototype.send=function(t){if(this.lctx.websocket.readyState!=s.WS_OPEN)throw new o(s.ERR_WEBSOCKET_NOTREADY);this.lctx.send(this,s.OP_CHANNEL_SEND,null,t,t.length)},s.Socket=function(t,e){this.lctx=t,this.id=void 0;var o=new n(this,null,e,!0);this.onready=o,this.onmessage=void 0,t.send(this,s.OP_SOCKET_NEW,this.ready),this.defer=i()},s.Socket.prototype.listen=function(t){this.lctx.send(this,s.OP_SOCKET_LISTEN,t)},s.Socket.prototype.ready=function(t,e,i,n){var o=t.obj;o.id=n,o.defer&&o.defer.resolve(),o.onready.trigger()},s.Query=function(){return this.filters=[],this.size=0,this},s.Query.prototype.key=function(t,e){return t&&e&&(this.filters.push({type:s.QUERY_DB,key:t}),this.filters.push({type:s.QUERY_KEY,key:e}),this.size+=t.length+e.length+12),this},s.Query.prototype.timestamp=function(t,e){return void 0!==t&&(void 0===e&&(e=s.QUERY_EQ),e|=s.QUERY_TIME,this.filters.push({type:e,key:t}),this.size+=t.length+6),this},s.Query.prototype.packed=function(){if(!this.size)return"";for(var t=new ArrayBuffer(this.size),i=new DataView(t),n=0,o=0;o<this.filters.length;o++){var s=this.filters[o].key,r=this.filters[o].type;i.setUint16(n,r),n+=2,i.setUint32(n,s.length),n=e(n+=4,s,s.length,i)}return t},s}(jQuery);
