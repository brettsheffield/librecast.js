var LIBRECAST=function(e){"use strict";function t(e,t,o,n){var s,i;for(i=0;i<o;i++)(s=t.charCodeAt(i))<=127?n.setUint8(e++,s):s<=2047?(n.setUint8(e++,192|s>>>6),n.setUint8(e++,128|63&s)):s<=65535?(n.setUint8(e++,224|s>>>12),n.setUint8(e++,128|s>>>6&63),n.setUint8(e++,128|63&s)):console.log("UTF-16 surrogate pair, ignoring");return e}function o(){if(p){console.log("jQuery available, returning deferred");try{return e.Deferred()}catch(e){console.log("unable to set deferred")}}}function n(e,t,o,n){this.obj=e,this.opcode=t,this.token=g++,this.temp=n,f[this.token]=this,"function"==typeof o&&(this.callback=o)}function s(e){this.code=e,this.name=d[e],this.errormsg="ERROR ("+this.code+") "+this.name}function i(e){if(console.log("Librecast constructor"),this.url="https:"==location.protocol?"wss://":"ws://",this.url+=document.location.host+"/",!window.WebSocket)throw console.log("websockets unsupported"),new s(r);console.log("websockets supported"),this.id=void 0,this.onmessage=null,this.onready=e,this.init(),this.defer=o()}function c(e,t,s){console.log("Channel constructor"),this.lctx=e,this.id=void 0,this.ws=e.websocket,this.name=t;var i=new n(this,null,s);this.onready=i,e.send(this,h,this.ready,t,t.length),this.defer=o()}function l(e,t){console.log("Socket constructor"),this.lctx=e,this.id=void 0;var s=new n(this,null,t,!0);this.onready=s,this.onmessage=void 0,e.send(this,a,this.ready),this.defer=o()}var r=2,a=3,h=10,d={};d[0]="Success",d[1]="Failure",d[r]="Browser does not support websockets",d[3]="Websocket not ready",d[4]="Callback not a function";var g=42,f={},p="undefined"!=typeof jQuery;return void 0===DataView.prototype.getUint64&&(DataView.prototype.getUint64=function(e,t){var o=t?0:4,n=t?4:0;return this.getUint32(e+n,t)<<32|this.getUint32(e+o,t)}),n.prototype.call=function(){if(void 0===f[this.token])return console.log("callback "+this.token+" undefined. Skipping."),!1;if(console.log("callback "+this.token+" triggered"),"function"==typeof this.callback){var e=[].slice.call(arguments);e.unshift(this),this.callback.apply(this,e)}this.temp&&(console.log("Deleting callback token "+this.token),delete f[this.token])},i.prototype.init=function(){console.log("Librecast.init()");var e=this;this.websocket=new WebSocket(this.url,"librecast"),this.websocket.binaryType="arraybuffer",this.websocket.onclose=function(t){e.wsClose(t)},this.websocket.onerror=function(t){e.wsError(t)},this.websocket.onmessage=function(t){e.wsMessage(t)},this.websocket.onopen=function(t){e.wsOpen(t)}},i.prototype.close=function(){console.log("Librecast close()"),this.websocket.close()},i.prototype.wsClose=function(e){console.log("websocket close: ("+e.code+") "+e.reason),console.log("websocket.readyState: "+this.websocket.readyState),console.log("reinitializing websocket"),this.init()},i.prototype.wsError=function(e){console.log("websocket error"+e.message),console.log("websocket.readyState: "+this.websocket.readyState)},i.prototype.wsMessage=function(e){console.log("websocket message received (type="+e.type+")");var t,n;if("object"==typeof e){if(e.data instanceof ArrayBuffer){var s=new DataView(e.data),i=s.getUint8(0),c=s.getUint32(1),l=s.getUint32(5),r=s.getUint32(9),a=s.getUint32(13),h=1e3*s.getUint64(17);if(console.log("opcode: "+i),console.log("len: "+c),console.log("id: "+l),console.log("id2: "+r),console.log("token: "+a),console.log("timestamp: "+h),c>0)if(15===i){var d=s.getUint64(25);t=new StringView(e.data,"UTF-8",33,d),n=new StringView(e.data,"UTF-8",33+d)}else{n=new StringView(e.data,"UTF-8",25,c).toString()}var g=f[a];g?g.call(i,c,l,a,t,n,h):console.log("message with no matching callback token '"+a+"'")}}else"function"==typeof this.onmessage&&console.log(e);return o()},i.prototype.wsOpen=function(e){console.log("websocket open"),console.log("websocket.readyState: "+this.websocket.readyState),this.defer&&(console.log("resolving Librecast.defer"),this.defer.resolve()),"function"==typeof this.onready&&this.onready()},i.prototype.send=function(e,o,s,i,c,l){void 0===c&&(c=0);var r=e.id,a=e.id2;void 0===e.id&&(r=0),void 0===e.id2&&(a=0);var h,d,g,f=new n(e,o,s,l);if(console.log("sending message ("+o+") with token '"+f.token+"'"),"object"==typeof i){g=25+c;var p=new Uint8Array(g);p.set(new Uint8Array(i),25),h=p.buffer,d=new DataView(h)}else h=new ArrayBuffer(25+4*c),g=t(25,i,c,d=new DataView(h));d.setUint8(0,o),d.setUint32(1,g-25),d.setUint32(5,r),d.setUint32(9,a),d.setUint32(13,f.token),this.websocket.send(h)},c.prototype.bind=function(e,t){console.log("binding channel "+this.name+" to socket "+e.id),this.id=this.id,this.id2=e.id,this.lctx.send(this,16,t)},c.prototype.bound=function(){console.log("bound channel")},c.prototype.join=function(e){console.log('joining channel "'+this.name+'"'),this.lctx.send(this,18,e)},c.prototype.joined=function(){console.log('joined channel "'+this.name+'"')},c.prototype.part=function(){console.log('parting channel "'+this.name+'"'),this.lctx.send(this,19,this.parted)},c.prototype.parted=function(){console.log('parted channel "'+this.name+'"')},c.prototype.ready=function(e,t,o,n){console.log("callback with opcode "+e.opcode+" and token "+e.token),console.log("setting channel id to "+n);var s=e.obj;s.id=n,s.defer&&(console.log("resolving Channel.defer"),s.defer.resolve()),s.onready.call()},c.prototype.getmsg=function(e){console.log("channel getmsgs");this.lctx.send(this,11,e,"","".length)},c.prototype.getval=function(e,t){console.log("channel getval '"+e+"'"),this.lctx.send(this,14,t,e,e.length,!0)},c.prototype.setval=function(e,o,n){console.log("channel setval '"+e+"': '"+o+"'");var s=e.length,i=o.length,c=4+4*(s+i),l=new ArrayBuffer(c),r=new DataView(l),a=4;r.setUint32(0,s),a=t(a=t(a,e,s,r),o,i,r),this.lctx.send(this,15,n,l,c,!0)},c.prototype.send=function(e){if(1!=this.lctx.websocket.readyState)throw new s(3);console.log('sending on channel "'+this.name+'": '+e),this.lctx.send(this,20,null,e,e.length)},l.prototype.listen=function(e){this.lctx.send(this,6,e)},l.prototype.ready=function(e,t,o,n){console.log("Socket.ready()");var s=e.obj;s.id=n,s.defer&&(console.log("resolving Socket.defer"),s.defer.resolve()),s.onready.call()},{}}(jQuery);
