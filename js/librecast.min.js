var LIBRECAST=function(t){"use strict";function e(t,e,n,i){var o,s;for(s=0;s<n;s++)(o=e.charCodeAt(s))<=127?i.setUint8(t++,o):o<=2047?(i.setUint8(t++,192|o>>>6),i.setUint8(t++,128|63&o)):o<=65535&&(i.setUint8(t++,224|o>>>12),i.setUint8(t++,128|o>>>6&63),i.setUint8(t++,128|63&o));return t}function n(){if(s.HAS_JQUERY)try{return t.Deferred()}catch(t){}}function i(t,e,n,i){this.obj=t,this.opcode=e,this.token=r++,this.temp=i,E[this.token]=this,"function"==typeof n&&(this.callback=n)}function o(t){this.code=t,this.name=s.ErrorMsg[t],this.errormsg="ERROR ("+this.code+") "+this.name}var s={};s.WS_CONNECTING=0,s.WS_OPEN=1,s.WS_CLOSING=2,s.WS_CLOSED=3,s.ERR_SUCCESS=0,s.ERR_FAILURE=1,s.ERR_WEBSOCKET_UNSUPPORTED=2,s.ERR_WEBSOCKET_NOTREADY=3,s.ERR_CALLBACK_NOT_FUNCTION=4,s.ERR_MISSING_ARG=5,s.OP_NOOP=1,s.OP_SETOPT=2,s.OP_SOCKET_NEW=3,s.OP_SOCKET_GETOPT=4,s.OP_SOCKET_SETOPT=5,s.OP_SOCKET_LISTEN=6,s.OP_SOCKET_IGNORE=7,s.OP_SOCKET_CLOSE=8,s.OP_SOCKET_MSG=9,s.OP_CHANNEL_NEW=10,s.OP_CHANNEL_GETMSG=11,s.OP_CHANNEL_GETOPT=12,s.OP_CHANNEL_SETOPT=13,s.OP_CHANNEL_GETVAL=14,s.OP_CHANNEL_SETVAL=15,s.OP_CHANNEL_BIND=16,s.OP_CHANNEL_UNBIND=17,s.OP_CHANNEL_JOIN=18,s.OP_CHANNEL_PART=19,s.OP_CHANNEL_SEND=20,s.HEADER_LENGTH=25,s.ErrorMsg={},s.ErrorMsg[s.ERR_SUCCESS]="Success",s.ErrorMsg[s.ERR_FAILURE]="Failure",s.ErrorMsg[s.ERR_WEBSOCKET_UNSUPPORTED]="Browser does not support websockets",s.ErrorMsg[s.ERR_WEBSOCKET_NOTREADY]="Websocket not ready",s.ErrorMsg[s.ERR_CALLBACK_NOT_FUNCTION]="Callback not a function",s.ErrorMsg[s.ERR_MISSING_ARGUMENT]="Required argument is missing";var r=42,E={};return s.HAS_JQUERY="undefined"!=typeof jQuery,void 0===DataView.prototype.getUint64&&(DataView.prototype.getUint64=function(t,e){var n=e?0:4,i=e?4:0;return this.getUint32(t+i,e)<<32|this.getUint32(t+n,e)}),i.prototype.trigger=function(){if(void 0===E[this.token])return!1;if("function"==typeof this.callback){var t=[].slice.call(arguments);t.unshift(this),this.callback.apply(this.obj,t)}this.temp&&delete E[this.token]},s.Context=function(t){if(this.url="https:"==location.protocol?"wss://":"ws://",this.url+=document.location.host+"/",!window.WebSocket)throw new o(s.ERR_WEBSOCKET_UNSUPPORTED);this.id=void 0,this.onmessage=null,this.onready=t,this.init(),this.defer=n()},s.Context.prototype.init=function(){var t=this;this.websocket=new WebSocket(this.url,"librecast"),this.websocket.binaryType="arraybuffer",this.websocket.onclose=function(e){t.wsClose(e)},this.websocket.onerror=function(e){t.wsError(e)},this.websocket.onmessage=function(e){t.wsMessage(e)},this.websocket.onopen=function(e){t.wsOpen(e)}},s.Context.prototype.close=function(){this.websocket.close()},s.Context.prototype.wsClose=function(t){this.init()},s.Context.prototype.wsError=function(t){},s.Context.prototype.wsMessage=function(t){var e,i;if("object"==typeof t){if(t.data instanceof ArrayBuffer){var o=new DataView(t.data),r=o.getUint8(0),h=o.getUint32(1),a=o.getUint32(5),_=(o.getUint32(9),o.getUint32(13)),c=1e3*o.getUint64(17);if(h>0)if(r===s.OP_CHANNEL_SETVAL){var N=o.getUint64(s.HEADER_LENGTH);e=new StringView(t.data,"UTF-8",s.HEADER_LENGTH+8,N),i=new StringView(t.data,"UTF-8",s.HEADER_LENGTH+8+N)}else{i=new StringView(t.data,"UTF-8",s.HEADER_LENGTH,h).toString()}var d=E[_];d&&d.trigger(r,h,a,_,e,i,c)}}else this.onmessage;return n()},s.Context.prototype.wsOpen=function(t){this.defer&&this.defer.resolve(),"function"==typeof this.onready&&this.onready()},s.Context.prototype.send=function(t,n,o,r,E,h){void 0===E&&(E=0);var a=t.id,_=t.id2;void 0===t.id&&(a=0),void 0===t.id2&&(_=0);var c,N,d,f=new i(t,n,o,h);if("object"==typeof r){d=s.HEADER_LENGTH+E;var C=new Uint8Array(d);C.set(new Uint8Array(r),s.HEADER_LENGTH),c=C.buffer,N=new DataView(c)}else c=new ArrayBuffer(s.HEADER_LENGTH+4*E),N=new DataView(c),d=e(s.HEADER_LENGTH,r,E,N);N.setUint8(0,n),N.setUint32(1,d-s.HEADER_LENGTH),N.setUint32(5,a),N.setUint32(9,_),N.setUint32(13,f.token),this.websocket.send(c)},s.Channel=function(t,e,r){if(void 0==e)throw new o(s.ERR_MISSING_ARG);this.lctx=t,this.id=void 0,this.ws=t.websocket,this.name=e;var E=new i(this,null,r);this.onready=E,t.send(this,s.OP_CHANNEL_NEW,this.ready,e,e.length),this.defer=n()},s.Channel.prototype.bindSocket=function(t){this.id=this.id,this.id2=t.id,this.lctx.send(this,s.OP_CHANNEL_BIND,this.bound)},s.Channel.prototype.bound=function(){},s.Channel.prototype.join=function(t){this.lctx.send(this,s.OP_CHANNEL_JOIN,t)},s.Channel.prototype.joined=function(){},s.Channel.prototype.part=function(){this.lctx.send(this,s.OP_CHANNEL_PART,this.parted)},s.Channel.prototype.parted=function(){},s.Channel.prototype.ready=function(t,e,n,i){var o=t.obj;o.id=i,o.defer&&o.defer.resolve(),o.onready.trigger()},s.Channel.prototype.getmsg=function(t){this.lctx.send(this,s.OP_CHANNEL_GETMSG,t,"","".length)},s.Channel.prototype.getval=function(t,e){this.lctx.send(this,s.OP_CHANNEL_GETVAL,e,t,t.length,!0)},s.Channel.prototype.setval=function(t,n,i){var o=t.length,r=n.length,E=4+4*(o+r),h=new ArrayBuffer(E),a=new DataView(h),_=4;a.setUint32(0,o),_=e(_=e(_,t,o,a),n,r,a),this.lctx.send(this,s.OP_CHANNEL_SETVAL,i,h,E,!0)},s.Channel.prototype.send=function(t){if(this.lctx.websocket.readyState!=s.WS_OPEN)throw new o(s.ERR_WEBSOCKET_NOTREADY);this.lctx.send(this,s.OP_CHANNEL_SEND,null,t,t.length)},s.Socket=function(t,e){this.lctx=t,this.id=void 0;var o=new i(this,null,e,!0);this.onready=o,this.onmessage=void 0,t.send(this,s.OP_SOCKET_NEW,this.ready),this.defer=n()},s.Socket.prototype.listen=function(t){this.lctx.send(this,s.OP_SOCKET_LISTEN,t)},s.Socket.prototype.ready=function(t,e,n,i){var o=t.obj;o.id=i,o.defer&&o.defer.resolve(),o.onready.trigger()},s}(jQuery);
