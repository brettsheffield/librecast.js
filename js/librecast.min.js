var LIBRECAST=function(t){"use strict";function e(t,e,n,i){var o,s;for(s=0;s<n;s++)(o=e.charCodeAt(s))<=127?i.setUint8(t++,o):o<=2047?(i.setUint8(t++,192|o>>>6),i.setUint8(t++,128|63&o)):o<=65535&&(i.setUint8(t++,224|o>>>12),i.setUint8(t++,128|o>>>6&63),i.setUint8(t++,128|63&o));return t}function n(){if(s.HAS_JQUERY)try{return t.Deferred()}catch(t){}}function i(t,e,n,i){this.obj=t,this.opcode=e,this.token=r++,this.temp=i,E[this.token]=this,"function"==typeof n&&(this.callback=n)}function o(t){this.code=t,this.name=s.ErrorMsg[t],this.errormsg="ERROR ("+this.code+") "+this.name}var s={};s.WS_CONNECTING=0,s.WS_OPEN=1,s.WS_CLOSING=2,s.WS_CLOSED=3,s.ERROR_SUCCESS=0,s.ERROR_FAILURE=1,s.ERROR_WEBSOCKET_UNSUPPORTED=2,s.ERROR_WEBSOCKET_NOTREADY=3,s.ERROR_CALLBACK_NOT_FUNCTION=4,s.OP_NOOP=1,s.OP_SETOPT=2,s.OP_SOCKET_NEW=3,s.OP_SOCKET_GETOPT=4,s.OP_SOCKET_SETOPT=5,s.OP_SOCKET_LISTEN=6,s.OP_SOCKET_IGNORE=7,s.OP_SOCKET_CLOSE=8,s.OP_SOCKET_MSG=9,s.OP_CHANNEL_NEW=10,s.OP_CHANNEL_GETMSG=11,s.OP_CHANNEL_GETOPT=12,s.OP_CHANNEL_SETOPT=13,s.OP_CHANNEL_GETVAL=14,s.OP_CHANNEL_SETVAL=15,s.OP_CHANNEL_BIND=16,s.OP_CHANNEL_UNBIND=17,s.OP_CHANNEL_JOIN=18,s.OP_CHANNEL_PART=19,s.OP_CHANNEL_SEND=20,s.HEADER_LENGTH=25,s.ErrorMsg={},s.ErrorMsg[s.ERROR_SUCCESS]="Success",s.ErrorMsg[s.ERROR_FAILURE]="Failure",s.ErrorMsg[s.ERROR_WEBSOCKET_UNSUPPORTED]="Browser does not support websockets",s.ErrorMsg[s.ERROR_WEBSOCKET_NOTREADY]="Websocket not ready",s.ErrorMsg[s.ERROR_CALLBACK_NOT_FUNCTION]="Callback not a function";var r=42,E={};return s.HAS_JQUERY="undefined"!=typeof jQuery,void 0===DataView.prototype.getUint64&&(DataView.prototype.getUint64=function(t,e){var n=e?0:4,i=e?4:0;return this.getUint32(t+i,e)<<32|this.getUint32(t+n,e)}),i.prototype.call=function(){if(void 0===E[this.token])return!1;if("function"==typeof this.callback){var t=[].slice.call(arguments);t.unshift(this),this.callback.apply(this,t)}this.temp&&delete E[this.token]},s.Context=function(t){if(this.url="https:"==location.protocol?"wss://":"ws://",this.url+=document.location.host+"/",!window.WebSocket)throw new o(ERROR_WEBSOCKET_UNSUPPORTED);this.id=void 0,this.onmessage=null,this.onready=t,this.init(),this.defer=n()},s.Context.prototype.init=function(){var t=this;this.websocket=new WebSocket(this.url,"librecast"),this.websocket.binaryType="arraybuffer",this.websocket.onclose=function(e){t.wsClose(e)},this.websocket.onerror=function(e){t.wsError(e)},this.websocket.onmessage=function(e){t.wsMessage(e)},this.websocket.onopen=function(e){t.wsOpen(e)}},s.Context.prototype.close=function(){this.websocket.close()},s.Context.prototype.wsClose=function(t){this.init()},s.Context.prototype.wsError=function(t){},s.Context.prototype.wsMessage=function(t){var e,i;if("object"==typeof t){if(t.data instanceof ArrayBuffer){var o=new DataView(t.data),r=o.getUint8(0),a=o.getUint32(1),h=o.getUint32(5),c=(o.getUint32(9),o.getUint32(13)),_=1e3*o.getUint64(17);if(a>0)if(r===s.OP_CHANNEL_SETVAL){var O=o.getUint64(s.HEADER_LENGTH);e=new StringView(t.data,"UTF-8",s.HEADER_LENGTH+8,O),i=new StringView(t.data,"UTF-8",s.HEADER_LENGTH+8+O)}else{i=new StringView(t.data,"UTF-8",s.HEADER_LENGTH,a).toString()}var N=E[c];N&&N.call(r,a,h,c,e,i,_)}}else this.onmessage;return n()},s.Context.prototype.wsOpen=function(t){this.defer&&this.defer.resolve(),"function"==typeof this.onready&&this.onready()},s.Context.prototype.send=function(t,n,o,r,E,a){void 0===E&&(E=0);var h=t.id,c=t.id2;void 0===t.id&&(h=0),void 0===t.id2&&(c=0);var _,O,N,l=new i(t,n,o,a);if("object"==typeof r){N=s.HEADER_LENGTH+E;var d=new Uint8Array(N);d.set(new Uint8Array(r),s.HEADER_LENGTH),_=d.buffer,O=new DataView(_)}else _=new ArrayBuffer(s.HEADER_LENGTH+4*E),O=new DataView(_),N=e(s.HEADER_LENGTH,r,E,O);O.setUint8(0,n),O.setUint32(1,N-s.HEADER_LENGTH),O.setUint32(5,h),O.setUint32(9,c),O.setUint32(13,l.token),this.websocket.send(_)},s.Channel=function(t,e,o){this.lctx=t,this.id=void 0,this.ws=t.websocket,this.name=e;var r=new i(this,null,o);this.onready=r,t.send(this,s.OP_CHANNEL_NEW,this.ready,e,e.length),this.defer=n()},s.Channel.prototype.bind=function(t,e){this.id=this.id,this.id2=t.id,this.lctx.send(this,s.OP_CHANNEL_BIND,e)},s.Channel.prototype.bound=function(){},s.Channel.prototype.join=function(t){this.lctx.send(this,s.OP_CHANNEL_JOIN,t)},s.Channel.prototype.joined=function(){},s.Channel.prototype.part=function(){this.lctx.send(this,s.OP_CHANNEL_PART,this.parted)},s.Channel.prototype.parted=function(){},s.Channel.prototype.ready=function(t,e,n,i){var o=t.obj;o.id=i,o.defer&&o.defer.resolve(),o.onready.call()},s.Channel.prototype.getmsg=function(t){this.lctx.send(this,s.OP_CHANNEL_GETMSG,t,"","".length)},s.Channel.prototype.getval=function(t,e){this.lctx.send(this,s.OP_CHANNEL_GETVAL,e,t,t.length,!0)},s.Channel.prototype.setval=function(t,n,i){var o=t.length,r=n.length,E=4+4*(o+r),a=new ArrayBuffer(E),h=new DataView(a),c=4;h.setUint32(0,o),c=e(c=e(c,t,o,h),n,r,h),this.lctx.send(this,s.OP_CHANNEL_SETVAL,i,a,E,!0)},s.Channel.prototype.send=function(t){if(this.lctx.websocket.readyState!=s.WS_OPEN)throw new o(ERROR_WEBSOCKET_NOTREADY);this.lctx.send(this,s.OP_CHANNEL_SEND,null,t,t.length)},s.Socket=function(t,e){this.lctx=t,this.id=void 0;var o=new i(this,null,e,!0);this.onready=o,this.onmessage=void 0,t.send(this,s.OP_SOCKET_NEW,this.ready),this.defer=n()},s.Socket.prototype.listen=function(t){this.lctx.send(this,s.OP_SOCKET_LISTEN,t)},s.Socket.prototype.ready=function(t,e,n,i){var o=t.obj;o.id=i,o.defer&&o.defer.resolve(),o.onready.call()},s}(jQuery);
