var LIBRECAST=function(t){"use strict";function e(t,e,i,n){var s,o;for(o=0;o<i;o++)(s=e.charCodeAt(o))<=127?n.setUint8(t++,s):s<=2047?(n.setUint8(t++,192|s>>>6),n.setUint8(t++,128|63&s)):s<=65535&&(n.setUint8(t++,224|s>>>12),n.setUint8(t++,128|s>>>6&63),n.setUint8(t++,128|63&s));return t}function i(){if(o.HAS_JQUERY)try{return t.Deferred()}catch(t){}}function n(t,e,i,n){this.obj=t,this.opcode=e,this.token=r++,this.temp=n,E[this.token]=this,"function"==typeof i&&(this.callback=i)}function s(t){this.code=t,this.name=o.ErrorMsg[t],this.errormsg="ERROR ("+this.code+") "+this.name}var o={};o.WS_CONNECTING=0,o.WS_OPEN=1,o.WS_CLOSING=2,o.WS_CLOSED=3,o.ERR_SUCCESS=0,o.ERR_FAILURE=1,o.ERR_WEBSOCKET_UNSUPPORTED=2,o.ERR_WEBSOCKET_NOTREADY=3,o.ERR_CALLBACK_NOT_FUNCTION=4,o.ERR_MISSING_ARG=5,o.OP_NOOP=1,o.OP_SETOPT=2,o.OP_SOCKET_NEW=3,o.OP_SOCKET_GETOPT=4,o.OP_SOCKET_SETOPT=5,o.OP_SOCKET_LISTEN=6,o.OP_SOCKET_IGNORE=7,o.OP_SOCKET_CLOSE=8,o.OP_SOCKET_MSG=9,o.OP_CHANNEL_NEW=10,o.OP_CHANNEL_GETMSG=11,o.OP_CHANNEL_GETOPT=12,o.OP_CHANNEL_SETOPT=13,o.OP_CHANNEL_GETVAL=14,o.OP_CHANNEL_SETVAL=15,o.OP_CHANNEL_BIND=16,o.OP_CHANNEL_UNBIND=17,o.OP_CHANNEL_JOIN=18,o.OP_CHANNEL_PART=19,o.OP_CHANNEL_SEND=20,o.QUERY_NOOP=0,o.QUERY_EQ=1,o.QUERY_NE=2,o.QUERY_LT=4,o.QUERY_GT=8,o.QUERY_TIME=16,o.QUERY_SRC=32,o.QUERY_DST=64,o.QUERY_CHANNEL=128,o.QUERY_DB=256,o.QUERY_KEY=512,o.QUERY_MIN=1024,o.QUERY_MAX=2048,o.HEADER_LENGTH=25,o.ErrorMsg={},o.ErrorMsg[o.ERR_SUCCESS]="Success",o.ErrorMsg[o.ERR_FAILURE]="Failure",o.ErrorMsg[o.ERR_WEBSOCKET_UNSUPPORTED]="Browser does not support websockets",o.ErrorMsg[o.ERR_WEBSOCKET_NOTREADY]="Websocket not ready",o.ErrorMsg[o.ERR_CALLBACK_NOT_FUNCTION]="Callback not a function",o.ErrorMsg[o.ERR_MISSING_ARGUMENT]="Required argument is missing";var r=42,E={};return o.HAS_JQUERY="undefined"!=typeof jQuery,n.prototype.trigger=function(){if(void 0===E[this.token])return!1;if("function"==typeof this.callback){var t=[].slice.call(arguments);t.unshift(this),this.callback.apply(this.obj,t)}this.temp&&delete E[this.token]},o.Context=function(t){if(this.url="https:"==location.protocol?"wss://":"ws://",this.url+=document.location.host+"/",!window.WebSocket)throw new s(o.ERR_WEBSOCKET_UNSUPPORTED);this.id=void 0,this.onmessage=null,this.onready=t,this.init(),this.defer=i()},o.Context.prototype.init=function(){var t=this;this.websocket=new WebSocket(this.url,"librecast"),this.websocket.binaryType="arraybuffer",this.websocket.onclose=function(e){t.wsClose(e)},this.websocket.onerror=function(e){t.wsError(e)},this.websocket.onmessage=function(e){t.wsMessage(e)},this.websocket.onopen=function(e){t.wsOpen(e)}},o.Context.prototype.close=function(){this.websocket.close()},o.Context.prototype.wsClose=function(t){this.init()},o.Context.prototype.wsError=function(t){},o.Context.prototype.wsMessage=function(t){var e,n;if("object"==typeof t){if(t.data instanceof ArrayBuffer){var s=new DataView(t.data),r=s.getUint8(0),h=s.getUint32(1),_=s.getUint32(5),a=(s.getUint32(9),s.getUint32(13)),c=1e3*s.getUint32(17);if(h>0)if(r===o.OP_CHANNEL_SETVAL){var N=s.getUint32(o.HEADER_LENGTH);e=new StringView(t.data,"UTF-8",o.HEADER_LENGTH+8,N),n=new StringView(t.data,"UTF-8",o.HEADER_LENGTH+8+N)}else{n=new StringView(t.data,"UTF-8",o.HEADER_LENGTH,h).toString()}var f=E[a];f&&f.trigger(r,h,_,a,e,n,c)}}else this.onmessage;return i()},o.Context.prototype.wsOpen=function(t){this.defer&&this.defer.resolve(),"function"==typeof this.onready&&this.onready()},o.Context.prototype.send=function(t,i,s,r,E,h){void 0===E&&(E=0);var _=t.id,a=t.id2;void 0===t.id&&(_=0),void 0===t.id2&&(a=0);var c,N,f,d=new n(t,i,s,h);if("object"==typeof r){f=o.HEADER_LENGTH+E;var l=new Uint8Array(f);l.set(new Uint8Array(r),o.HEADER_LENGTH),c=l.buffer,N=new DataView(c)}else c=new ArrayBuffer(o.HEADER_LENGTH+4*E),N=new DataView(c),f=e(o.HEADER_LENGTH,r,E,N);N.setUint8(0,i),N.setUint32(1,f-o.HEADER_LENGTH),N.setUint32(5,_),N.setUint32(9,a),N.setUint32(13,d.token),this.websocket.send(c)},o.Channel=function(t,e,r){if(void 0==e)throw new s(o.ERR_MISSING_ARG);this.lctx=t,this.id=void 0,this.ws=t.websocket,this.name=e;var E=new n(this,null,r);this.onready=E,t.send(this,o.OP_CHANNEL_NEW,this.ready,e,e.length),this.defer=i()},o.Channel.prototype.bindSocket=function(t,e){this.id=this.id,this.id2=t.id,this.lctx.send(this,o.OP_CHANNEL_BIND,e)},o.Channel.prototype.join=function(t){this.lctx.send(this,o.OP_CHANNEL_JOIN,t)},o.Channel.prototype.joined=function(){},o.Channel.prototype.part=function(){this.lctx.send(this,o.OP_CHANNEL_PART,this.parted)},o.Channel.prototype.parted=function(){},o.Channel.prototype.ready=function(t,e,i,n){var s=t.obj;s.id=n,s.defer&&s.defer.resolve(),s.onready.trigger()},o.Channel.prototype.getmsg=function(t,e){void 0===e&&(e=new o.Query),this.lctx.send(this,o.OP_CHANNEL_GETMSG,t,e.packed(),e.size)},o.Channel.prototype.getval=function(t,e){this.lctx.send(this,o.OP_CHANNEL_GETVAL,e,t,t.length,!0)},o.Channel.prototype.setval=function(t,i,n){var s=t.length,r=i.length,E=4+4*(s+r),h=new ArrayBuffer(E),_=new DataView(h),a=4;_.setUint32(0,s),a=e(a=e(a,t,s,_),i,r,_),this.lctx.send(this,o.OP_CHANNEL_SETVAL,n,h,E,!0)},o.Channel.prototype.send=function(t){if(this.lctx.websocket.readyState!=o.WS_OPEN)throw new s(o.ERR_WEBSOCKET_NOTREADY);this.lctx.send(this,o.OP_CHANNEL_SEND,null,t,t.length)},o.Socket=function(t,e){this.lctx=t,this.id=void 0;var s=new n(this,null,e,!0);this.onready=s,this.onmessage=void 0,t.send(this,o.OP_SOCKET_NEW,this.ready),this.defer=i()},o.Socket.prototype.listen=function(t){this.lctx.send(this,o.OP_SOCKET_LISTEN,t)},o.Socket.prototype.ready=function(t,e,i,n){var s=t.obj;s.id=n,s.defer&&s.defer.resolve(),s.onready.trigger()},o.Query=function(){return this.filters=[],this.size=0,this},o.Query.prototype.key=function(t,e){return this.filters.push({type:o.QUERY_DB,key:t}),this.filters.push({type:o.QUERY_KEY,key:e}),this.size+=t.length+e.length+7,this},o.Query.prototype.timestamp=function(t,e){return void 0!==t&&(void 0===e&&(e=o.QUERY_EQ),e|=o.QUERY_TIME,t=""+t,this.filters.push({type:e,key:t}),this.size+=t.length+5),this},o.Query.prototype.packed=function(){if(0===this.size)return"";for(var t=new ArrayBuffer(this.size),i=new DataView(t),n=0,s=0;s<this.filters.length;s++){var o=this.filters[s].key,r=this.filters[s].type;i.setUint8(n,r),n+=1,i.setUint32(n,o.length),n=e(n+=4,o,o.length,i)}return t},o}(jQuery);
