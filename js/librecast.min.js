var LIBRECAST=function(e){"use strict";function t(e,t,o,n){var s,i;for(i=0;i<o;i++)(s=t.charCodeAt(i))<=127?n.setUint8(e++,s):s<=2047?(n.setUint8(e++,192|s>>>6),n.setUint8(e++,128|63&s)):s<=65535?(n.setUint8(e++,224|s>>>12),n.setUint8(e++,128|s>>>6&63),n.setUint8(e++,128|63&s)):console.log("UTF-16 surrogate pair, ignoring");return e}function o(){if(i.HAS_JQUERY){console.log("jQuery available, returning deferred");try{return e.Deferred()}catch(e){console.log("unable to set deferred")}}}function n(e,t,o,n){this.obj=e,this.opcode=t,this.token=c++,this.temp=n,r[this.token]=this,"function"==typeof o&&(this.callback=o)}function s(e){this.code=e,this.name=i.ErrorMsg[e],this.errormsg="ERROR ("+this.code+") "+this.name}var i={};i.WS_CONNECTING=0,i.WS_OPEN=1,i.WS_CLOSING=2,i.WS_CLOSED=3,i.ERROR_SUCCESS=0,i.ERROR_FAILURE=1,i.ERROR_WEBSOCKET_UNSUPPORTED=2,i.ERROR_WEBSOCKET_NOTREADY=3,i.ERROR_CALLBACK_NOT_FUNCTION=4,i.OP_NOOP=1,i.OP_SETOPT=2,i.OP_SOCKET_NEW=3,i.OP_SOCKET_GETOPT=4,i.OP_SOCKET_SETOPT=5,i.OP_SOCKET_LISTEN=6,i.OP_SOCKET_IGNORE=7,i.OP_SOCKET_CLOSE=8,i.OP_SOCKET_MSG=9,i.OP_CHANNEL_NEW=10,i.OP_CHANNEL_GETMSG=11,i.OP_CHANNEL_GETOPT=12,i.OP_CHANNEL_SETOPT=13,i.OP_CHANNEL_GETVAL=14,i.OP_CHANNEL_SETVAL=15,i.OP_CHANNEL_BIND=16,i.OP_CHANNEL_UNBIND=17,i.OP_CHANNEL_JOIN=18,i.OP_CHANNEL_PART=19,i.OP_CHANNEL_SEND=20,i.HEADER_LENGTH=25,i.ErrorMsg={},i.ErrorMsg[i.ERROR_SUCCESS]="Success",i.ErrorMsg[i.ERROR_FAILURE]="Failure",i.ErrorMsg[i.ERROR_WEBSOCKET_UNSUPPORTED]="Browser does not support websockets",i.ErrorMsg[i.ERROR_WEBSOCKET_NOTREADY]="Websocket not ready",i.ErrorMsg[i.ERROR_CALLBACK_NOT_FUNCTION]="Callback not a function";var c=42,r={};return i.HAS_JQUERY="undefined"!=typeof jQuery,void 0===DataView.prototype.getUint64&&(DataView.prototype.getUint64=function(e,t){var o=t?0:4,n=t?4:0;return this.getUint32(e+n,t)<<32|this.getUint32(e+o,t)}),n.prototype.call=function(){if(void 0===r[this.token])return console.log("callback "+this.token+" undefined. Skipping."),!1;if(console.log("callback "+this.token+" triggered"),"function"==typeof this.callback){var e=[].slice.call(arguments);e.unshift(this),this.callback.apply(this,e)}this.temp&&(console.log("Deleting callback token "+this.token),delete r[this.token])},i.Librecast=function(e){if(console.log("Librecast constructor"),this.url="https:"==location.protocol?"wss://":"ws://",this.url+=document.location.host+"/",!window.WebSocket)throw console.log("websockets unsupported"),new s(ERROR_WEBSOCKET_UNSUPPORTED);console.log("websockets supported"),this.id=void 0,this.onmessage=null,this.onready=e,this.init(),this.defer=o()},i.Librecast.prototype.init=function(){console.log("Librecast.init()");var e=this;this.websocket=new WebSocket(this.url,"librecast"),this.websocket.binaryType="arraybuffer",this.websocket.onclose=function(t){e.wsClose(t)},this.websocket.onerror=function(t){e.wsError(t)},this.websocket.onmessage=function(t){e.wsMessage(t)},this.websocket.onopen=function(t){e.wsOpen(t)}},i.Librecast.prototype.close=function(){console.log("Librecast close()"),this.websocket.close()},i.Librecast.prototype.wsClose=function(e){console.log("websocket close: ("+e.code+") "+e.reason),console.log("websocket.readyState: "+this.websocket.readyState),console.log("reinitializing websocket"),this.init()},i.Librecast.prototype.wsError=function(e){console.log("websocket error"+e.message),console.log("websocket.readyState: "+this.websocket.readyState)},i.Librecast.prototype.wsMessage=function(e){console.log("websocket message received (type="+e.type+")");var t,n;if("object"==typeof e){if(e.data instanceof ArrayBuffer){var s=new DataView(e.data),c=s.getUint8(0),l=s.getUint32(1),a=s.getUint32(5),h=s.getUint32(9),E=s.getUint32(13),d=1e3*s.getUint64(17);if(console.log("opcode: "+c),console.log("len: "+l),console.log("id: "+a),console.log("id2: "+h),console.log("token: "+E),console.log("timestamp: "+d),l>0)if(c===i.OP_CHANNEL_SETVAL){var g=s.getUint64(i.HEADER_LENGTH);t=new StringView(e.data,"UTF-8",i.HEADER_LENGTH+8,g),n=new StringView(e.data,"UTF-8",i.HEADER_LENGTH+8+g)}else{n=new StringView(e.data,"UTF-8",i.HEADER_LENGTH,l).toString()}var _=r[E];_?_.call(c,l,a,E,t,n,d):console.log("message with no matching callback token '"+E+"'")}}else"function"==typeof this.onmessage&&console.log(e);return o()},i.Librecast.prototype.wsOpen=function(e){console.log("websocket open"),console.log("websocket.readyState: "+this.websocket.readyState),this.defer&&(console.log("resolving Librecast.defer"),this.defer.resolve()),"function"==typeof this.onready&&this.onready()},i.Librecast.prototype.send=function(e,o,s,c,r,l){void 0===r&&(r=0);var a=e.id,h=e.id2;void 0===e.id&&(a=0),void 0===e.id2&&(h=0);var E,d,g,_=new n(e,o,s,l);if(console.log("sending message ("+o+") with token '"+_.token+"'"),"object"==typeof c){g=HEADER_LENGTH+r;var O=new Uint8Array(g);O.set(new Uint8Array(c),i.HEADER_LENGTH),E=O.buffer,d=new DataView(E)}else E=new ArrayBuffer(i.HEADER_LENGTH+4*r),d=new DataView(E),g=t(i.HEADER_LENGTH,c,r,d);d.setUint8(0,o),d.setUint32(1,g-i.HEADER_LENGTH),d.setUint32(5,a),d.setUint32(9,h),d.setUint32(13,_.token),this.websocket.send(E)},i.LibrecastChannel=function(e,t,s){console.log("Channel constructor"),this.lctx=e,this.id=void 0,this.ws=e.websocket,this.name=t;var c=new n(this,null,s);this.onready=c,e.send(this,i.OP_CHANNEL_NEW,this.ready,t,t.length),this.defer=o()},i.LibrecastChannel.prototype.bind=function(e,t){console.log("binding channel "+this.name+" to socket "+e.id),this.id=this.id,this.id2=e.id,this.lctx.send(this,i.OP_CHANNEL_BIND,t)},i.LibrecastChannel.prototype.bound=function(){console.log("bound channel")},i.LibrecastChannel.prototype.join=function(e){console.log('joining channel "'+this.name+'"'),this.lctx.send(this,i.OP_CHANNEL_JOIN,e)},i.LibrecastChannel.prototype.joined=function(){console.log('joined channel "'+this.name+'"')},i.LibrecastChannel.prototype.part=function(){console.log('parting channel "'+this.name+'"'),this.lctx.send(this,i.OP_CHANNEL_PART,this.parted)},i.LibrecastChannel.prototype.parted=function(){console.log('parted channel "'+this.name+'"')},i.LibrecastChannel.prototype.ready=function(e,t,o,n){console.log("callback with opcode "+e.opcode+" and token "+e.token),console.log("setting channel id to "+n);var s=e.obj;s.id=n,s.defer&&(console.log("resolving Channel.defer"),s.defer.resolve()),s.onready.call()},i.LibrecastChannel.prototype.getmsg=function(e){console.log("channel getmsgs");this.lctx.send(this,i.OP_CHANNEL_GETMSG,e,"","".length)},i.LibrecastChannel.prototype.getval=function(e,t){console.log("channel getval '"+e+"'"),this.lctx.send(this,i.OP_CHANNEL_GETVAL,t,e,e.length,!0)},i.LibrecastChannel.prototype.setval=function(e,o,n){console.log("channel setval '"+e+"': '"+o+"'");var s=e.length,c=o.length,r=4+4*(s+c),l=new ArrayBuffer(r),a=new DataView(l),h=4;a.setUint32(0,s),h=t(h=t(h,e,s,a),o,c,a),this.lctx.send(this,i.OP_CHANNEL_SETVAL,n,l,r,!0)},i.LibrecastChannel.prototype.send=function(e){if(this.lctx.websocket.readyState!=i.WS_OPEN)throw new s(ERROR_WEBSOCKET_NOTREADY);console.log('sending on channel "'+this.name+'": '+e),this.lctx.send(this,i.OP_CHANNEL_SEND,null,e,e.length)},i.LibrecastSocket=function(e,t){console.log("Socket constructor"),this.lctx=e,this.id=void 0;var s=new n(this,null,t,!0);this.onready=s,this.onmessage=void 0,e.send(this,i.OP_SOCKET_NEW,this.ready),this.defer=o()},i.LibrecastSocket.prototype.listen=function(e){this.lctx.send(this,i.OP_SOCKET_LISTEN,e)},i.LibrecastSocket.prototype.ready=function(e,t,o,n){console.log("Socket.ready()");var s=e.obj;s.id=n,s.defer&&(console.log("resolving Socket.defer"),s.defer.resolve()),s.onready.call()},i}(jQuery);
